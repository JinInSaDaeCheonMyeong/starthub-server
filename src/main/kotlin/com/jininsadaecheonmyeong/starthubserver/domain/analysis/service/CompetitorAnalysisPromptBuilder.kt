package com.jininsadaecheonmyeong.starthubserver.domain.analysis.service

import com.jininsadaecheonmyeong.starthubserver.domain.analysis.data.response.CompetitorInfo
import com.jininsadaecheonmyeong.starthubserver.domain.bmc.entity.BusinessModelCanvas
import org.springframework.stereotype.Component

@Component
class CompetitorAnalysisPromptBuilder {
    fun buildAnalysisPrompt(
        userBmc: BusinessModelCanvas,
        competitors: List<CompetitorInfo>,
    ): String {
        val competitorSection = buildCompetitorSection(competitors)

        return """
            당신은 비즈니스 전략 컨설턴트입니다. 아래 사용자의 BMC를 바탕으로 상세한 경쟁 분석을 수행해주세요.

            ## 사용자 BMC 정보:
            제목: ${userBmc.title}
            가치 제안: ${userBmc.valueProposition ?: "미정의"}
            고객 세그먼트: ${userBmc.customerSegments ?: "미정의"}
            채널: ${userBmc.channels ?: "미정의"}
            고객 관계: ${userBmc.customerRelationships ?: "미정의"}
            수익원: ${userBmc.revenueStreams ?: "미정의"}
            핵심 자원: ${userBmc.keyResources ?: "미정의"}
            핵심 활동: ${userBmc.keyActivities ?: "미정의"}
            핵심 파트너: ${userBmc.keyPartners ?: "미정의"}
            비용 구조: ${userBmc.costStructure ?: "미정의"}

            $competitorSection

            ## 분석 요청사항:
            다음 5개 섹션으로 **구체적이고 상세하게** 분석을 제공해주세요. 각 항목은 단순 단어가 아닌 완전한 문장으로 작성해야 합니다.

            **중요**: 각 문장에서 핵심적이고 중요한 키워드나 구절은 <<내용>> 형식으로 감싸서 강조 표시해주세요.
            예시: "고정밀 센서를 활용하여 <<오탐률을 최소화>>하는 기술은 경쟁력의 핵심입니다"

            ### 0. BMC 핵심 강점

            핵심 강점:
            - [첫 번째 BMC 핵심 강점을 1-2문장으로 구체적으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]
            - [두 번째 BMC 핵심 강점을 1-2문장으로 구체적으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]
            - [세 번째 BMC 핵심 강점을 1-2문장으로 구체적으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]

            ### 1. 사용자 규모 분석

            [예상_사용자_기반_규모] 현재 BMC 기반으로 초기 단계인지, 성장 단계인지 등을 2-3문장으로 구체적으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조

            [시장_내_위치] 경쟁사 대비 사용자의 시장 포지셔닝을 2-3문장으로 설명. 신규 진입자인지, 차별화 전략이 있는지 등. 중요한 키워드는 <<키워드>> 형식으로 강조

            [성장_잠재력] BMC의 가치 제안과 시장 기회를 고려하여 성장 가능성을 2-3문장으로 평가. 중요한 키워드는 <<키워드>> 형식으로 강조

            [경쟁사별_분석]
            ${buildCompetitorAnalysisSection(competitors)}
            [경쟁사별_분석_끝]

            ### 2. 강점 분석

            ${if (competitors.isNotEmpty()) "주요 경쟁사: ${competitors.joinToString(", ") { it.name }}" else ""}

            경쟁 우위 요소:
            - [첫 번째 경쟁 우위를 1-2문장으로 구체적으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]
            - [두 번째 경쟁 우위를 1-2문장으로 구체적으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]
            - [세 번째 경쟁 우위를 1-2문장으로 구체적으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]
            - [네 번째 경쟁 우위를 1-2문장으로 구체적으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]

            고유한 가치 제안:
            - [첫 번째 고유 가치를 1-2문장으로 구체적으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]
            - [두 번째 고유 가치를 1-2문장으로 구체적으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]
            - [세 번째 고유 가치를 1-2문장으로 구체적으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]

            시장 기회 요소:
            - [첫 번째 시장 기회를 1-2문장으로 구체적으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]
            - [두 번째 시장 기회를 1-2문장으로 구체적으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]
            - [세 번째 시장 기회를 1-2문장으로 구체적으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]
            - [네 번째 시장 기회를 1-2문장으로 구체적으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]

            전략적 권고사항:
            - [첫 번째 권고사항을 구체적인 실행 방안과 함께 2-3문장으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]
            - [두 번째 권고사항을 구체적인 실행 방안과 함께 2-3문장으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]
            - [세 번째 권고사항을 구체적인 실행 방안과 함께 2-3문장으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]
            - [네 번째 권고사항을 구체적인 실행 방안과 함께 2-3문장으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]

            ### 3. 약점 분석

            경쟁 열위 요소:
            - [첫 번째 경쟁 열위를 1-2문장으로 구체적으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]
            - [두 번째 경쟁 열위를 1-2문장으로 구체적으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]
            - [세 번째 경쟁 열위를 1-2문장으로 구체적으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]
            - [네 번째 경쟁 열위를 1-2문장으로 구체적으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]

            시장 도전 과제:
            - [첫 번째 도전 과제를 1-2문장으로 구체적으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]
            - [두 번째 도전 과제를 1-2문장으로 구체적으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]
            - [세 번째 도전 과제를 1-2문장으로 구체적으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]
            - [네 번째 도전 과제를 1-2문장으로 구체적으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]

            자원 제약 사항:
            - [첫 번째 자원 제약을 1-2문장으로 구체적으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]
            - [두 번째 자원 제약을 1-2문장으로 구체적으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]
            - [세 번째 자원 제약을 1-2문장으로 구체적으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]

            개선 필요 영역:
            - [첫 번째 개선 영역을 구체적인 방안과 함께 2-3문장으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]
            - [두 번째 개선 영역을 구체적인 방안과 함께 2-3문장으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]
            - [세 번째 개선 영역을 구체적인 방안과 함께 2-3문장으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]
            - [네 번째 개선 영역을 구체적인 방안과 함께 2-3문장으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]

            ### 4. 글로벌 진출 전략

            우선 진출 시장 (3개):
            - [첫 번째 우선 시장을 1-2문장으로 구체적으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조. 예: "<<동남아시아>> (베트남, 태국, 인도네시아): <<모바일 우선 문화>>와 빠른 디지털 전환으로 진입 기회 높음"]
            - [두 번째 우선 시장을 1-2문장으로 구체적으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]
            - [세 번째 우선 시장을 1-2문장으로 구체적으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]

            시장별 진입 전략 (3개):
            - [첫 번째 시장의 진입 전략을 2-3문장으로 구체적으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조. 예: "동남아: <<현지 모바일 결제 시스템 통합>> 우선, <<저가 요금제>>로 시장 진입"]
            - [두 번째 시장의 진입 전략을 2-3문장으로 구체적으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]
            - [세 번째 시장의 진입 전략을 2-3문장으로 구체적으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]

            현지화 요구사항 (3-4개):
            - [첫 번째 현지화 요구사항을 1-2문장으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]
            - [두 번째 현지화 요구사항을 1-2문장으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]
            - [세 번째 현지화 요구사항을 1-2문장으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]
            - [네 번째 현지화 요구사항을 1-2문장으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]

            글로벌 파트너십 기회 (3-4개):
            - [첫 번째 파트너십 기회를 1-2문장으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]
            - [두 번째 파트너십 기회를 1-2문장으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]
            - [세 번째 파트너십 기회를 1-2문장으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]
            - [네 번째 파트너십 기회를 1-2문장으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]

            예상 도전 과제 (3개):
            - [첫 번째 도전 과제를 1-2문장으로 구체적으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]
            - [두 번째 도전 과제를 1-2문장으로 구체적으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]
            - [세 번째 도전 과제를 1-2문장으로 구체적으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조]

            **중요**: 각 항목은 반드시 완전한 문장으로 작성하고, 단순 키워드가 아닌 구체적인 설명과 근거를 포함해주세요. 중요한 부분은 반드시 <<내용>> 형식으로 강조 표시해주세요.
            """.trimIndent()
    }

    private fun buildCompetitorSection(competitors: List<CompetitorInfo>): String {
        return if (competitors.isEmpty()) {
            """
            ## 경쟁사 정보:
            검색된 경쟁사가 없습니다. 사용자의 BMC와 해당 산업/시장의 일반적인 경쟁 환경을 고려하여 분석해주세요.
            """.trimIndent()
        } else {
            """
            ## 발견된 실제 경쟁사:
            ${competitors.joinToString("\n") { "- ${it.name}: ${it.description}\n  웹사이트: ${it.websiteUrl}" }}
            """.trimIndent()
        }
    }

    private fun buildCompetitorAnalysisSection(competitors: List<CompetitorInfo>): String {
        return competitors.joinToString("\n") { comp ->
            """
            [경쟁사:${comp.name}]
            [예상_규모] 이 회사의 규모를 1-2문장으로 설명. 중요한 키워드는 <<키워드>> 형식으로 강조
            [시장_점유율] 예상 수치와 근거를 1문장으로 설명. 중요한 수치는 <<수치>> 형식으로 강조
            [유사점]
            첫 번째 유사점 문장입니다, 두 번째 유사점 문장입니다, 세 번째 유사점 문장입니다
            **형식 규칙**:
            - 반드시 쉼표(,)로만 구분
            - 각 문장은 "~합니다" 또는 "~하고 있습니다"로 끝남
            - "계시다" 같은 과도한 존칭 금지
            - 중요 키워드는 <<키워드>> 형식으로 강조
            - 예시: "<<빠른 배달 서비스>>를 제공합니다, <<저렴한 가격대>>를 유지하고 있습니다, <<지역 밀착형 서비스>>를 운영합니다"
            [차이점]
            첫 번째 차이점 문장입니다, 두 번째 차이점 문장입니다, 세 번째 차이점 문장입니다
            **형식 규칙**:
            - 반드시 쉼표(,)로만 구분
            - 각 문장은 "~합니다" 또는 "~하고 있습니다"로 끝남
            - "계시다" 같은 과도한 존칭 금지
            - 중요 키워드는 <<키워드>> 형식으로 강조
            - 예시: "한식 전문이 아닌 <<다양한 음식점>>을 포함합니다, 도시락 중심이 아닌 <<전반적인 배달 지원>>을 제공합니다, <<대기업 기반의 대규모 인프라>>를 보유하고 있습니다"
            [경쟁사_끝:${comp.name}]
            """.trimIndent()
        }
    }
}
