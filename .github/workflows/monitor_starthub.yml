name: Monitor Tailscale starthub

on:
  schedule:
    - cron: "*/3 * * * *"
  workflow_dispatch:

jobs:
  check-starthub:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Set up dependencies (jq)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Load previous status
        id: prev
        run: |
          FILE="starthub_status.txt"

          if [ ! -f "$FILE" ]; then
            echo "unknown" > "$FILE"
          fi

          PREV_STATUS=$(cat "$FILE" | tr -d '[:space:]')

          if [ -z "$PREV_STATUS" ]; then
            PREV_STATUS="unknown"
          fi

          echo "Previous status: $PREV_STATUS"
          echo "prev_status=$PREV_STATUS" >> $GITHUB_OUTPUT

      - name: Check current status from Tailscale
        id: current
        env:
          TAILSCALE_API_KEY: ${{ secrets.TAILSCALE_API_KEY }}
          STARTHUB_DEVICE_ID: ${{ secrets.STARTHUB_DEVICE_ID }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          set -e

          if [ -z "$TAILSCALE_API_KEY" ]; then
            echo "TAILSCALE_API_KEY is not set"
            exit 1
          fi

          if [ -z "$STARTHUB_DEVICE_ID" ]; then
            echo "STARTHUB_DEVICE_ID is not set"
            exit 1
          fi

          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "DISCORD_WEBHOOK_URL is not set"
            exit 1
          fi

          DEVICE_JSON=$(curl -sS \
            -H "Authorization: Bearer $TAILSCALE_API_KEY" \
            "https://api.tailscale.com/api/v2/device/${STARTHUB_DEVICE_ID}")

          if [ -z "$DEVICE_JSON" ] || [ "$DEVICE_JSON" = "null" ]; then
            echo "Failed to fetch device info"
            echo "current_status=unknown" >> $GITHUB_OUTPUT
            exit 0
          fi

          CONNECTED=$(echo "$DEVICE_JSON" | jq -r '.connectedToControl // empty')
          LAST_SEEN=$(echo "$DEVICE_JSON" | jq -r '.lastSeen // empty')
          HOSTNAME=$(echo "$DEVICE_JSON" | jq -r '.hostname // "unknown"')
          NAME=$(echo "$DEVICE_JSON" | jq -r '.name // "unknown"')

          echo "Device Name: $NAME"
          echo "Hostname: $HOSTNAME"
          echo "ConnectedToControl: $CONNECTED"
          echo "Last seen: $LAST_SEEN"

          if [ "$CONNECTED" = "true" ]; then
            CUR_STATUS="online"
          else
            CUR_STATUS="offline"
          fi

          echo "Current status: $CUR_STATUS"

          echo "current_status=$CUR_STATUS" >> $GITHUB_OUTPUT
          echo "hostname=$HOSTNAME" >> $GITHUB_OUTPUT
          echo "last_seen=$LAST_SEEN" >> $GITHUB_OUTPUT
          echo "device_name=$NAME" >> $GITHUB_OUTPUT

      - name: Compare status and notify if changed
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}
          PREV_STATUS: ${{ steps.prev.outputs.prev_status }}
          CUR_STATUS: ${{ steps.current.outputs.current_status }}
          HOSTNAME: ${{ steps.current.outputs.hostname }}
          LAST_SEEN: ${{ steps.current.outputs.last_seen }}
          DEVICE_NAME: ${{ steps.current.outputs.device_name }}
        run: |
          echo "Previous: $PREV_STATUS"
          echo "Current : $CUR_STATUS"

          if [ -z "$CUR_STATUS" ]; then
            echo "No current status (maybe device not found). Skipping notification."
            exit 0
          fi

          if [ "$PREV_STATUS" = "$CUR_STATUS" ]; then
            echo "Status not changed. No notification."
            exit 0
          fi

          echo "Status changed! Sending Discord notification..."

          NOW=$(date -u '+%Y-%m-%d %H:%M:%S KST' --date='9 hours ago')

          if [ "$CUR_STATUS" = "offline" ]; then
            TITLE="⚠️ starthub-ubuntu 호스트가 오프라인임"
            BODY="서버의 작동 상태를 확인해주세요."
          else
            TITLE="✅ 서버가 온라인 상태로 변경됨"
            BODY="서버가 정상 작동합니다."
          fi

          MESSAGE_CONTENT="**${TITLE}**\n\n${BODY}\n\n**상세정보:**\n• 호스트: ${HOSTNAME}\n• 기기명: ${DEVICE_NAME}\n• 마지막 접속: ${LAST_SEEN}\n\n**알림시간:** ${NOW}"

          curl -sS -H "Content-Type: application/json" \
            -X POST \
            -d "$(jq -n \
              --arg title "$TITLE" \
              --arg description "$BODY" \
              --arg timestamp "$NOW" \
              --arg hostname "$HOSTNAME" \
              --arg device_name "$DEVICE_NAME" \
              --arg last_seen "$LAST_SEEN" \
              '{
                content: $title,
                embeds: [{
                  description: $description,
                  color: ($cur_status == "offline" | if . then 16711680 else 65280 end),
                  fields: [
                    {name: "호스트", value: $hostname, inline: true},
                    {name: "기기명", value: $device_name, inline: true},
                    {name: "마지막 접속", value: $last_seen, inline: false}
                  ],
                  timestamp: $timestamp
                }]
              }')" \
            "$DISCORD_WEBHOOK_URL"

          echo "$CUR_STATUS" > starthub_status.txt

      - name: Commit status change
        if: steps.prev.outputs.prev_status != steps.current.outputs.current_status
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add starthub_status.txt
          git commit -m "Update starthub status: ${{ steps.prev.outputs.prev_status }} -> ${{ steps.current.outputs.current_status }}" || echo "No changes to commit"
          git push
